{% extends "layout.html" %}

{% block title %}
Feed
{% endblock %}

{% block main %}
<div class="container mx-auto px-auto" style="display: flex; flex-direction: column;">
    <button id="toggle-item-feed-postar" type="button" class="btn btn-primary gothic-bold">Postar nova Proposta</button>

    <div class="card mx-auto item-feed item-feed-postar">
        <div class="card-body">
            <form method="post" action="/postar" novalidate>
                {{ formDeProposta.csrf_token }}
                <div class="row tipo-titulo">
                    <div class="mb-2 div-postar-tipo" style="display: inline-block;">
                        <label class="form-label tipo-proposta-label gothic-bold" for="tipo_proposta">Criar
                            um(a)</label>
                        <select class="form-select gothic" name="tipo_proposta" id="tipo_proposta">
                            {% for tipo, valor in tipo_proposta.items() %}
                            {% if valor == 0 %}
                            <option selected value="{{ valor }}">{{ tipo }}</option>
                            {% else %}
                            <option value="{{ valor }}">{{ tipo }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-2 div-postar-titulo" style="display: inline-block;">
                        {{ formDeProposta.titulo.label(class_="form-label postar-titulo-label") }}
                        {{ formDeProposta.titulo(class_="form-control postar-titulo gothic") }}
                        {% for error in formDeProposta.titulo.errors %}
                        <span class="text-danger gothic-bold">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
                <div class="mb-2 row" style="width: 100%; margin-left: auto; margin-right: auto;">
                    {{ formDeProposta.membro.label(class_="form-label gothic-bold postar-membro-label") }}
                    {{ formDeProposta.membro(class_="form-control gothic adicionar-membro") }}
                    <button id="adicionar_membro_btn" type="button"
                        class="btn btn-info gothic-bold adicionar-membro-btn"
                        style="display: inline-block; width: fit-content; margin-left: 6px;">Adicionar</button>
                    <span class="text-danger gothic-bold" id="adicionar_membro_span" style="margin-top: 6px;"></span>
                    <ul class="mt-3" id="lista_de_membros" style="list-style: none;">
                    </ul>
                    <div id="div_invisivel_membros">

                    </div>
                </div>
                <div class="mb-2">
                    {{ formDeProposta.descricao(class_="form-control postar-descricao gothic") }}
                    {% for error in formDeProposta.descricao.errors %}
                    <span class="text-danger gothic-bold">{{ error }}</span>
                    {% endfor %}
                </div>
                <div class="mb-2" style="display: inline-block; width: 100%;">
                    {{ formDeProposta.restricao_idade.label(class_="form-label restricao-idade-label gothic-bold") }}
                    {{ formDeProposta.restricao_idade(class_="form-control postar-restricao-idade gothic") }}
                    {% for error in formDeProposta.restricao_idade.errors %}
                    <span class="text-danger gothic-bold">{{ error }}</span>
                    {% endfor %}
                </div>
                <div class="mb-2 form-check" style="width: 100%; margin-left: auto; margin-right: auto;">
                    <input name="privado" class="form-check-input" type="checkbox" id="privado">
                    <label class="form-check-label gothic-bold" for="privado" style="width: 100%; text-align: start;">
                        É privado?
                    </label>
                </div>
                <br>
                <div class="mb-3 row mx-2">
                    {% for categoria, valor in categorias.items() %}
                    <div class="form-check col-md-4">
                        <input name="categorias" class="form-check-input" type="checkbox" value="{{ valor }}"
                            id="{{ valor }}">
                        <label class="form-check-label gothic-bold" for="{{ valor }}">
                            {{ categoria }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
                <button type="submit" class="btn btn-info gothic-bold"
                    style="display: block; margin-left: auto;">Postar</button>
            </form>
        </div>
    </div>

    {% for proposta in todas_propostas_nao_privadas %}
    <div class="card mx-auto mt-3 item-feed">
        <div class="card-body">
            <h5 class="card-title gothic-bold" style="text-align: start;">{{ proposta.titulo }}</h5>
            <div class="categorias-proposta">
                {% for categoria in proposta.categorias %}
                <h6 class="card-subtitle mb-2 text-muted categorias-proposta-item gothic">{{ categoria.nome }}</h6>
                {% endfor %}
            </div>
            <p class="card-text" style="text-align: justify;">{{ proposta.descricao }}</p>
            <div class="comentar-participar-feed">
                <a href="#" class="card-link btn btn-info gothic-bold">Comentar</a>
                <a href="#" class="card-link btn btn-primary gothic-bold">Solicitar para participar</a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script type="text/javascript">
    function formatar_baseado_em_largura() {
        if ($(window).width() < 600) {
            $('#toggle-item-feed-postar').css("visibility", "visible");
            $('#toggle-item-feed-postar').css("height", "38px");
            $('.item-feed-postar').css("visibility", "hidden");
        } else {
            $('#toggle-item-feed-postar').css("visibility", "hidden");
            $('#toggle-item-feed-postar').css("height", "0px");
            $('.item-feed-postar').css("visibility", "visible");
        }
    }

    $(document).ready(function () {
        formatar_baseado_em_largura();
    });

    $(window).resize(function () {
        formatar_baseado_em_largura();
    });

    $(document).ready(function () {
        $('#toggle-item-feed-postar').on("click", function () {
            $('#toggle-item-feed-postar').css("visibility", "hidden");
            $('#toggle-item-feed-postar').css("height", "0px");
            $('.item-feed-postar').css("visibility", "visible");
        });
    });
</script>

<script type="text/javascript">
    $(function () {
        $.ajax({
            url: '{{ url_for("todos_usuarios") }}'
        }).done(function (data) {
            $('#apelido_autocomplete').autocomplete({
                source: data,
                minLenght: 2
            })
        });
    });
</script>

<script type="text/javascript">
    $(document).ready(function () {
        var membros = [];
        var apelido_do_usuario = '{{ user.apelido }}'

        $('#adicionar_membro_btn').on("click", function () {
            membro = $('#apelido_autocomplete').val();

            if (membro == apelido_do_usuario) {
                $('#adicionar_membro_span').text("Você será adicionado automaticamente ao projeto");
                $('#apelido_autocomplete').val("");
                return
            }

            jQuery.ajax({
                url: '{{ url_for("checar_usuario") }}',
                data: {
                    apelido: membro
                },
                success: function (response) {
                    if (response["status"] == 404) {
                        $('#adicionar_membro_span').text(response["mensagem"]);
                    } else if (response["status"] == 200) {
                        $('#apelido_autocomplete').val("")
                        if (membros.includes(response["mensagem"])) {
                            $('#adicionar_membro_span').text("Usuário já adicionado");
                        } else {
                            $('#adicionar_membro_span').text("");

                            membros.push(response["mensagem"]);

                            aleatorio = (Math.floor(Math.random() * 3)) + 1

                            console.log(membros);

                            classe_aleatoria = aleatorio == 1 ? "membros_lista_amarelo" : aleatorio == 2 ? "membros_lista_azul" : aleatorio == 3 ? "membros_lista_bege" : "membros_lista";

                            var $list = $("<li>", { id: "foo", "class": classe_aleatoria });
                            $list.append(response["mensagem"]);
                            $('#lista_de_membros').append($list);

                            $('#div_invisivel_membros').text("");
                            membros.forEach(element => {
                                $('<input>').attr({
                                    type: 'hidden',
                                    name: 'membros',
                                    value: element
                                }).appendTo('#div_invisivel_membros');
                            });
                        }
                    }
                }
            })
        });
    });
</script>
{% endblock %}